{
  "name": "kafka-service",
  "category": "compute",
  "namespace": "my-namespace",
  "billing": {
    "model": "flat",
    "period": "monthly",
    "currency": "euro",
    "fixedPrice": 20,
    "variablePrice": 10
  },
  "compute": {
    "vms": [
      {
        "name": "xpanse-kafka-vm",
        "type": "c7.large.4",
        "imageId": "a3ef71cc-a5e4-11ed-9ec8-13266ec44838",
        "subnets": [
          "$.network.subnets[0]"
        ],
        "securityGroups": [
          "$.network.securityGroups[0]"
        ],
        "storages": [
          "$.storages[0]"
        ],
        "publicly": true,
        "userData": {
          "type": "shell",
          "commands": [
            "echo \"start install docker\"",
            "echo \"run install\"",
            "apt-get update",
            "apt install -y docker.io",
            "docker network create app-tier --driver bridge",
            "docker run -d --name zookeeper-server --network app-tier -e ALLOW_ANONYMOUS_LOGIN=yes bitnami/zookeeper:latest",
            "docker run -d --name kafka-server --network app-tier -e ALLOW_PLAINTEXT_LISTENER=yes -e KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper-server:2181 bitnami/kafka:latest",
            "echo \"@reboot docker restart zookeeper-server ; docker container rm kafka-server ; docker run -d --name kafka-server --network app-tier -p 9092:9092  -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://\\`hostname\\`:9092 -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 -e ALLOW_PLAINTEXT_LISTENER=yes -e KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper-server:2181 bitnami/kafka:latest\" | crontab -"
          ]
        }
      }
    ]
  },
  "network": {
    "vpc": [
      {
        "name": "xpanse-res-vpc",
        "cidr": "10.10.0.0/16"
      }
    ],
    "subnets": [
      {
        "name": "xpanse-res-subnet",
        "vpc": "$.network.vpc[0]",
        "cidr": "10.10.1.0/24"
      }
    ],
    "securityGroups": [
      {
        "name": "xpanse-res-sg",
        "rules": [
          {
            "name": "xpanse-res-sg-kafka",
            "priority": 1,
            "protocol": "tcp",
            "cidr": "10.10.2.6/32",
            "direction": "in",
            "ports": "8080, 9092-9093, 2181",
            "action": "allow"
          },
          {
            "name": "xpanse-res-sg-ssh-public",
            "priority": 1,
            "protocol": "tcp",
            "cidr": "121.36.59.153/32",
            "direction": "in",
            "ports": "22, 8080, 9092-9093,2181",
            "action": "allow"
          },
          {
            "name": "xpanse-res-sg-ssh-private",
            "priority": 1,
            "protocol": "tcp",
            "cidr": "198.19.0.0/16",
            "direction": "in",
            "ports": "22",
            "action": "allow"
          }
        ]
      }
    ]
  },
  "storages": [
    {
      "name": "xpanse-res-storage",
      "type": "SAS",
      "size": "20",
      "sizeUnit": "GB"
    }
  ]
}